# OpenTracing listener for Flogo

This listener adds OpenTracing instrumentation at Flogo engine level and tracers implementations
(Zipkin over HTTP or Kafka, Jaeger) to send traces generated by flows and activities to corresponding collectors.

For an introduction of concepts, read the [OpenTracing documentation](http://opentracing.io/documentation/). 

## Installation

### Flogo Web

This listener is not available yet with the Flogo Web UI.

### Flogo CLI

#### Override dependencies

In the directory of a Flogo project (with a *flogo.json* file), run:

```bash
cat << EOF >> ./src/test-opentracing/Gopkg.toml


[[constraint]]
  name = "github.com/TIBCOSoftware/flogo-contrib"
  branch = "flow-audit-events"

[[constraint]]
  name = "github.com/TIBCOSoftware/flogo-lib"
  branch = "event-handler-support"

[[override]]
  name = "github.com/apache/thrift"
  branch = "master"
EOF

flogo ensure
```

#### Install the contribution

In the directory of a Flogo project (with a *flogo.json* file), run:

```bash
flogo install github.com/debovema/flogo-opentracing-listener
```

#### Build and run

Finally, build the application:
```bash
flogo build -e
```

The binary is ready to be run in ```./bin``` directory.

## Usage

To use this listener once it is installed, **no modification of source code is required**.
Instead, it is only required to define an [application-level configuration](#configuration) and to run a [collector](#collectors).

### Configuration

Currently, all flows of an application have the same OpenTracing configuration set using environment variables.

For instance, to enable collection of traces by a Zipkin collector over HTTP transport:
```bash
export FLOGO_OPENTRACING_IMPLEMENTATION=zipkin
export FLOGO_OPENTRACING_TRANSPORT=http
export FLOGO_OPENTRACING_ENDPOINTS=http://127.0.0.1:9411/api/v1/spans
```

Replace *127.0.0.1* by the actual IP of the Zipkin collector.

#### Environment variables reference

| Environment variable             | Possible values                                                                                                        | Description                                                                                                                                         |
|----------------------------------|------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------|
| FLOGO_OPENTRACING_IMPLEMENTATION | zipkin, jaeger                                                                                                         | Choose which implementation of OpenTracing tracer to use.<br />Zipkin and Jaeger are available                                                      |
| FLOGO_OPENTRACING_TRANSPORT      | http, kafka(for zipkin only)                                                                                           | *http* is supported by both Zipkin and Jaeger<br />*kafka* is only supported by Zipkin                                                              |
| FLOGO_OPENTRACING_ENDPOINTS      | http://127.0.0.1:9411/api/v1/spans (zipkin over HTTP) 10.1.0.1:29092,10.1.0.2:29092,10.1.0.3:29092 (zipkin over Kafka) | A comma-separated list of endpoints                                                                                                                 |

### Collectors

This model can send traces to the following collectors:
* [Zipkin](https://zipkin.io/) over HTTP transport
* Zipkin over Kafka transport
* [Jaeger](https://www.jaegertracing.io/) over HTTP transport

For test purposes, here are quick methods to get collectors up and running locally, using Docker. 

#### Zipkin

##### HTTP transport

To start a single-node instance of a Zipkin server with HTTP transport, run:

```bash
docker run --name zipkin -d -p 9411:9411 openzipkin/zipkin
```

If using Docker Machine, replace *127.0.0.1* by the IP of the active Docker Machine (usually *192.168.99.100*,
```echo $(docker-machine ip $(docker-machine active))``` to display the IP).

##### Kafka transport

For Kafka transport, start a single-node instance of a Kafka server with its Zookeeper:

```bash
mkdir -p /tmp/kafka
cd /tmp/kafka
curl -fsSL https://raw.githubusercontent.com/confluentinc/cp-docker-images/5.0.0-post/examples/kafka-single-node/docker-compose.yml -o docker-compose.yml
# uncomment if using Docker Machine
# sed -i "s|localhost:|$(docker-machine ip $(docker-machine active)):|" docker-compose.yml
docker-compose up -d
```

Then start a single-node instance of a Zipkin server with Kafka transport by running:

```bash
docker run --name zipkin -d -p 9411:9411 -e KAFKA_BOOTSTRAP_SERVERS=127.0.0.1:29092 openzipkin/zipkin
```

If using Docker Machine, run instead:
```bash
docker run --name zipkin -d -p 9411:9411 -e KAFKA_BOOTSTRAP_SERVERS=$(docker-machine ip $(docker-machine active)):29092 openzipkin/zipkin
```

If using Docker Machine, replace *127.0.0.1* by the IP of the active Docker Machine (usually *192.168.99.100*,
```echo $(docker-machine ip $(docker-machine active))``` to display the IP).

#### Jaeger

##### HTTP transport

To start a single-node instance of a Jaeger server with HTTP transport, run:

```bash
docker run -d --name jaeger \
  -e COLLECTOR_ZIPKIN_HTTP_PORT=9411 \
  -p 5775:5775/udp \
  -p 6831:6831/udp \
  -p 6832:6832/udp \
  -p 5778:5778 \
  -p 16686:16686 \
  -p 14268:14268 \
  -p 9411:9411 \
  jaegertracing/all-in-one
```

If using Docker Machine, replace *127.0.0.1* by the IP of the active Docker Machine (usually *192.168.99.100*,
```echo $(docker-machine ip $(docker-machine active))``` to display the IP).
